apiVersion: v1
kind: ConfigMap
metadata:
  name: livekit-server-config
  namespace: call-center
data:
  config.yaml: |
    port: 7880
    rtc:
      port_range_start: 50000
      port_range_end: 60000
      use_external_ip: false
      tcp_fallback_port: 7881
    redis:
      address: redis.call-center.svc.cluster.local:6379
    logging:
      level: info
      pion_level: warn
    # TURN servers (STUNner) â€” populated after STUNner LB IP is known
    # turn:
    #   enabled: true
    #   domain: call-center.hellojade.ai
    #   tls_port: 5349
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: livekit-server
  namespace: call-center
  labels:
    app: livekit-server
    app.kubernetes.io/part-of: ai-call-center
spec:
  replicas: 2
  selector:
    matchLabels:
      app: livekit-server
  template:
    metadata:
      labels:
        app: livekit-server
    spec:
      serviceAccountName: livekit-server
      terminationGracePeriodSeconds: 18000
      containers:
        - name: livekit
          image: livekit/livekit-server:latest
          ports:
            - containerPort: 7880
              name: signaling
            - containerPort: 7881
              name: rtc-tcp
          env:
            - name: LIVEKIT_API_KEY
              valueFrom:
                secretKeyRef:
                  name: livekit-secrets
                  key: LIVEKIT_API_KEY
            - name: LIVEKIT_API_SECRET
              valueFrom:
                secretKeyRef:
                  name: livekit-secrets
                  key: LIVEKIT_API_SECRET
          resources:
            requests:
              cpu: "1"
              memory: "2Gi"
            limits:
              cpu: "2"
              memory: "4Gi"
          volumeMounts:
            - name: config
              mountPath: /etc/livekit
          args:
            - "--config"
            - "/etc/livekit/config.yaml"
          livenessProbe:
            httpGet:
              path: /
              port: 7880
            initialDelaySeconds: 10
            periodSeconds: 15
          readinessProbe:
            httpGet:
              path: /
              port: 7880
            initialDelaySeconds: 5
            periodSeconds: 5
      volumes:
        - name: config
          configMap:
            name: livekit-server-config
---
apiVersion: v1
kind: Service
metadata:
  name: livekit-server
  namespace: call-center
  annotations:
    cloud.google.com/neg: '{"ingress": true}'
spec:
  selector:
    app: livekit-server
  ports:
    - name: signaling
      port: 7880
      targetPort: 7880
    - name: rtc-tcp
      port: 7881
      targetPort: 7881
